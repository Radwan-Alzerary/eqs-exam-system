<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>اليوم الافتراضي - <%= dayName %></title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Tajawal', sans-serif;
    }
    /* تنسيق النافذة المنبثقة (المودال) */
    #viewerModal {
      justify-content: center;
      align-items: center;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      overflow: hidden;
    }
    /* زر الإغلاق */
    #closeBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #closeBtn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* زر التنزيل */
    #downloadBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #1d4ed8; /* درجة من الأزرق */
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      text-decoration: none; /* لأنه رابط */
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    #downloadBtn:hover {
      background: #2563eb; /* درجة أفتح من الأزرق */
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">
      الملفات في اليوم الافتراضي: <%= dayName %>
    </h1>
    
    <!-- قائمة الملفات -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      <% files.forEach(fileName => {
          const ext = fileName.split('.').pop().toLowerCase();

          // تعيين نوع الملف (type) لعرضه في <embed>
          let fileType, embedType;
          switch (ext) {
            case 'pdf':
              fileType = 'مستند PDF';
              embedType = 'application/pdf';
              break;
            case 'mp4':
              fileType = 'فيديو MP4';
              embedType = 'video/mp4';
              break;
            case 'mov':
              fileType = 'فيديو MOV';
              embedType = 'video/quicktime';
              break;
            case 'mp3':
              fileType = 'صوت MP3';
              embedType = 'audio/mpeg';
              break;
            case 'wav':
              fileType = 'صوت WAV';
              embedType = 'audio/wav';
              break;
            case 'jpg':
            case 'jpeg':
              fileType = 'صورة JPEG';
              embedType = 'image/jpeg';
              break;
            case 'png':
              fileType = 'صورة PNG';
              embedType = 'image/png';
              break;
            case 'gif':
              fileType = 'صورة GIF';
              embedType = 'image/gif';
              break;
            default:
              // أنواع أخرى غير معروفة
              fileType = 'نوع ملف غير معروف';
              // يمكن وضع type عام مثل application/octet-stream
              embedType = 'application/octet-stream';
              break;
          }
      %>
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-2 truncate"><%= fileName %></h3>
          <p class="text-sm text-gray-600 mb-4"><%= fileType %></p>
          <div class="flex justify-between">
            <!-- زر لفتح الـ Modal وعرض الملف -->
            <button 
              onclick="openViewer(
                '/cloud/view/<%= dayName %>/<%= fileName %>', 
                '<%= embedType %>', 
                '<%= fileName %>'
              )" 
              class="text-green-500 hover:text-green-600"
            >
              عرض <i>👁️</i>
            </button>
          </div>
        </div>
      </div>
      <% }) %>
    </div>
  </div>

  <!-- النافذة المنبثقة (Modal) لعرض الملف -->
  <div 
    id="viewerModal" 
    class="hidden flex"
  >
    <!-- زر الإغلاق -->
    <button id="closeBtn" onclick="closeViewer()">إغلاق</button>

    <!-- زر التنزيل (رابط تحميل) -->
    <a id="downloadBtn" href="#" download>تنزيل</a>

    <!-- تضمين الملف هنا -->
    <embed 
      id="fileEmbed" 
      src="" 
      type="" 
      class="mx-auto my-auto w-11/12 h-5/6" 
    >
  </div>

  <script>
    /**
     * فتح المودال وتضمين الملف في الـ embed + إعداد زر التنزيل
     * @param {string} fileUrl  المسار الكامل للملف
     * @param {string} mimeType نوع MIME (مثل application/pdf)
     * @param {string} fileName اسم الملف للتحميل
     */
    function openViewer(fileUrl, mimeType, fileName) {
      const modal = document.getElementById('viewerModal');
      const fileEmbed = document.getElementById('fileEmbed');
      const downloadBtn = document.getElementById('downloadBtn');
      
      // تعيين src و type في الـ <embed>
      fileEmbed.src = fileUrl;
      fileEmbed.type = mimeType;

      // تجهيز رابط التنزيل
      downloadBtn.href = fileUrl;
      // تحديد اسم الملف في "download" لجعله يظهر عند الحفظ
      downloadBtn.setAttribute('download', fileName);

      // إظهار النافذة المنبثقة
      modal.classList.remove('hidden');
    }

    // دالة لإغلاق الـ Modal
    function closeViewer() {
      const modal = document.getElementById('viewerModal');
      const fileEmbed = document.getElementById('fileEmbed');
      const downloadBtn = document.getElementById('downloadBtn');
      
      // إخفاء النافذة المنبثقة
      modal.classList.add('hidden');

      // إفراغ الـ src و الـ type عند الإغلاق (اختياري للتنظيف)
      fileEmbed.src = "";
      fileEmbed.type = "";

      // إعادة زر التنزيل إلى حالته الافتراضية
      downloadBtn.href = "#";
      downloadBtn.removeAttribute('download');
    }
  </script>
</body>
</html>
