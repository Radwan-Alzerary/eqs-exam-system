<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ - <%= dayName %></title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Tajawal', sans-serif;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Ø§Ù„Ù…ÙˆØ¯Ø§Ù„) */
    #viewerModal {
      justify-content: center;
      align-items: center;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      overflow: hidden;
    }

    /* Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
    #closeBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #closeBtn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„ */
    #downloadBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #1d4ed8;
      /* Ø¯Ø±Ø¬Ø© Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ù‚ */
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      text-decoration: none;
      /* Ù„Ø£Ù†Ù‡ Ø±Ø§Ø¨Ø· */
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    #downloadBtn:hover {
      background: #2563eb;
      /* Ø¯Ø±Ø¬Ø© Ø£ÙØªØ­ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ù‚ */
    }

    video {
      width: 20%;
      max-width: 300px;
      border: 2px solid #12A9B0;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    /* ==================================
       ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ÙˆØ¯Ø§Ù„
       ================================== */
    #cameraModal {
      position: fixed;
      inset: 0;
      display: none;
      /* initially hidden */
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      padding: 20px;
    }

    #cameraModal.active {
      display: flex;
      /* show when active */
    }

    .camera-modal-content {
      background-color: #fff;
      border-radius: 8px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      position: relative;
    }

    .close-camera-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
    }

    .close-camera-btn:hover {
      background: #ff4c4c;
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
    .btn {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    .btn:hover {
      background-color: #0056b3;
    }

    #error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">
      Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: <%= dayName %>
    </h1>

    <!-- Ø²Ø± ÙØªØ­ ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ÙˆØ¯Ø§Ù„ -->
    <button class="btn bg-green-600 hover:bg-green-700" onclick="openCameraModal()">
      ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± (ÙƒØ§Ù…ÙŠØ±Ø§)
    </button>

    <!-- Ø²Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù„Ø±Ù…Ø² QR -->
    <p class="mt-4 text-gray-700">
      Ø£Ùˆ Ø§Ø®ØªØ± ØµÙˆØ±Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…Ø² QR:
    </p>
    <button class="btn bg-blue-600 hover:bg-blue-700" onclick="document.getElementById('fileInput').click()">
      Ø§Ø®ØªØ± Ù…Ù„Ù QR
    </button>
    <input 
    type="file" 
    id="fileInput" 
    accept="image/*" 
    capture="environment" 
    style="display:none;"
  />

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-8">
      <% files.forEach(fileName => {
          const ext = fileName.split('.').pop().toLowerCase();

          // ØªØ¹ÙŠÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù (type) Ù„Ø¹Ø±Ø¶Ù‡ ÙÙŠ <embed>
          let fileType, embedType;
          switch (ext) {
            case 'pdf':
              fileType = 'Ù…Ø³ØªÙ†Ø¯ PDF';
              embedType = 'application/pdf';
              break;
            case 'mp4':
              fileType = 'ÙÙŠØ¯ÙŠÙˆ MP4';
              embedType = 'video/mp4';
              break;
            case 'mov':
              fileType = 'ÙÙŠØ¯ÙŠÙˆ MOV';
              embedType = 'video/quicktime';
              break;
            case 'mp3':
              fileType = 'ØµÙˆØª MP3';
              embedType = 'audio/mpeg';
              break;
            case 'wav':
              fileType = 'ØµÙˆØª WAV';
              embedType = 'audio/wav';
              break;
            case 'jpg':
            case 'jpeg':
              fileType = 'ØµÙˆØ±Ø© JPEG';
              embedType = 'image/jpeg';
              break;
            case 'png':
              fileType = 'ØµÙˆØ±Ø© PNG';
              embedType = 'image/png';
              break;
            case 'gif':
              fileType = 'ØµÙˆØ±Ø© GIF';
              embedType = 'image/gif';
              break;
            default:
              // Ø£Ù†ÙˆØ§Ø¹ Ø£Ø®Ø±Ù‰ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©
              fileType = 'Ù†ÙˆØ¹ Ù…Ù„Ù ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
              embedType = 'application/octet-stream';
              break;
          }
      %>
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-2 truncate">
            <%= fileName %>
          </h3>
          <p class="text-sm text-gray-600 mb-4">
            <%= fileType %>
          </p>
          <div class="flex justify-between">
            <!-- Ø²Ø± Ù„ÙØªØ­ Ø§Ù„Ù€ Modal ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù -->
            <button onclick="openViewer(
              '/cloud/view/<%= dayName %>/<%= fileName %>', 
              '<%= embedType %>', 
              '<%= fileName %>'
            )" class="text-green-500 hover:text-green-600">
              Ø¹Ø±Ø¶ <i>ğŸ‘ï¸</i>
            </button>
          </div>
        </div>
      </div>
      <% }) %>
    </div>
  </div>

  <!-- Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù -->
  <div id="viewerModal" class="hidden flex">
    <!-- Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ -->
    <button id="closeBtn" onclick="closeViewer()">Ø¥ØºÙ„Ø§Ù‚</button>

    <!-- Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„ (Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„) -->
    <a id="downloadBtn" href="#" download>ØªÙ†Ø²ÙŠÙ„</a>

    <!-- ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ -->
    <embed id="fileEmbed" src="" type="" class="mx-auto my-auto w-11/12 h-5/6">
  </div>

  <!-- ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ÙˆØ¯Ø§Ù„ -->
  <div id="cameraModal">
    <div class="camera-modal-content">
      <!-- Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
      <button class="close-camera-btn" onclick="closeCameraModal()">Ø¥ØºÙ„Ø§Ù‚</button>

      <div id="response" style="color:red; margin-bottom: 10px;"></div>

      <div>
        <button id="toggle-camera-btn" class="btn">Switch Camera</button>
        <button id="manual-check-btn" class="btn">Manual Check</button>
      </div>

      <video id="video" autoplay style="width: 100%;"></video>
      <div id="output" style="margin-top: 10px;">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div>
      <div id="error"></div>
    </div>
  </div>

  <!-- jsQR library -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr"></script>

  <script>
    // ------------- Variables -------------
    const video = document.getElementById('video');
    const output = document.getElementById('output');
    const responseOutput = document.getElementById('response');
    const error = document.getElementById('error');
    const toggleCameraBtn = document.getElementById('toggle-camera-btn');
    const manualCheckBtn = document.getElementById('manual-check-btn');
    const cameraModal = document.getElementById('cameraModal');
    const fileInput = document.getElementById('fileInput');

    let useEnvironmentCamera = true; // Track which camera to use
    let currentStream = null;       // Store the active camera stream
    let lastScannedCode = null;     // Avoid repeating POST requests
    let scanning = false;           // Controls scanning loop

    // ------------- Modal Controls -------------
    function openCameraModal() {
      // Show the modal
      cameraModal.classList.add('active');
      // Start the camera
      startCamera('environment');
    }

    function closeCameraModal() {
      // Hide the modal
      cameraModal.classList.remove('active');
      // Stop the camera
      stopStream();
      // Reset scanning
      scanning = false;
      lastScannedCode = null;
    }

    // ------------- Camera Access -------------
    // Stop existing stream
    function stopStream() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
      currentStream = null;
    }

    // Request camera access with specified facingMode
    async function startCamera(facingMode = 'environment') {
      stopStream();
      output.textContent = 'Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
      error.textContent = '';
      scanning = false;  // ensure a fresh start

      try {
        const constraints = {
          video: {
            facingMode: { ideal: facingMode } // Ø§Ø³ØªØ®Ø¯Ù… ideal Ø¨Ø¯Ù„ exact Ù„ØªÙØ§Ø¯ÙŠ OverconstrainedError
          }
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
        scanning = true;
        // Kick off scanning loop
        scanQRCodeLoop();
      } catch (err) {
        console.warn('Preferred camera failed, trying fallback:', err);
        try {
          const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: true });
          currentStream = fallbackStream;
          video.srcObject = fallbackStream;
          scanning = true;
          scanQRCodeLoop();
        } catch (fallbackErr) {
          showError(fallbackErr);
        }
      }
    }

    // Switch camera
    toggleCameraBtn.addEventListener('click', () => {
      useEnvironmentCamera = !useEnvironmentCamera;
      const mode = useEnvironmentCamera ? 'environment' : 'user';
      startCamera(mode);
    });

    // Display errors
    function showError(err) {
      console.error('Camera Error: ', err);
      error.textContent = 'Unable to access the camera: ' + err.message;
    }

    // ------------- QR Scanning -------------
    function scanQRCodeLoop() {
      if (!scanning) return;

      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');

      const scan = () => {
        if (!scanning) return; // stop scanning if we are not in scanning mode
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);

          // Decode QR
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);

          if (code && code.data && code.data !== lastScannedCode) {
            lastScannedCode = code.data;
            output.textContent = `QR Code Detected: ${code.data}`;
            postToServer(code.data);
          } else if (!code) {
            output.textContent = 'Scanning...';
          }
        }
        setTimeout(scan, 500);
      };
      scan();
    }

    // Manual Check (captures one frame and tries to decode)
    manualCheckBtn.addEventListener('click', () => {
      if (video.readyState !== video.HAVE_ENOUGH_DATA) {
        output.textContent = 'Camera not ready yet!';
        return;
      }
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);

      if (code && code.data) {
        output.textContent = `Manual QR Code: ${code.data}`;
        postToServer(code.data);
      } else {
        output.textContent = 'No QR code found in the captured image.';
      }
    });

    // ------------- POST data to server -------------
    function postToServer(qrData) {
      fetch('/qr/usercheck/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ qrData })
      })
        .then(response => response.json())
        .then(data => {
          console.log('Server response:', data);
          if (data.isValid === false) {
            responseOutput.style.color = 'red';
            responseOutput.textContent = `Ø§Ù„ QR Ù…Ù†ØªÙ‡ÙŠ Ø§Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­`;
            const fileInput = document.getElementById('fileInput');
            fileInput.value = ''; // This clears the selected file

          } else {
            responseOutput.style.color = 'green';
            responseOutput.textContent = `Ù…Ø±Ø­Ø¨Ø§ Ø§Ø³ØªØ§Ø° ${data.name} ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­`;
            alert(`Ù…Ø±Ø­Ø¨Ø§ Ø§Ø³ØªØ§Ø° ${data.name} ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­`)
            const fileInput = document.getElementById('fileInput');
            fileInput.value = ''; // This clears the selected file

          }
        })
        .catch(err => {
          console.error('Error posting QR data:', err);
        });
    }

    // ------------- File Input Fallback -------------
    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect(event) {
      console.log(event)
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          // Ø§Ù„Ø±Ø³Ù… Ø¹Ù„Ù‰ Canvas
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          context.drawImage(img, 0, 0, canvas.width, canvas.height);

          // ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ jsQR
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);

          if (code && code.data) {
            output.textContent = `File QR Code: ${code.data}`;
            postToServer(code.data);
          } else {
            output.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² QR ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©.';
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  </script>

  <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ù€ Modal (Ù„Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªÙ†Ø²ÙŠÙ„) -->
  <script>
    /**
     * ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù€ embed + Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„
     * @param {string} fileUrl  Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ù„Ù
     * @param {string} mimeType Ù†ÙˆØ¹ MIME (Ù…Ø«Ù„ application/pdf)
     * @param {string} fileName Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù„Ù„ØªØ­Ù…ÙŠÙ„
     */
    function openViewer(fileUrl, mimeType, fileName) {
      const modal = document.getElementById('viewerModal');
      const fileEmbed = document.getElementById('fileEmbed');
      const downloadBtn = document.getElementById('downloadBtn');

      // ØªØ¹ÙŠÙŠÙ† src Ùˆ type ÙÙŠ Ø§Ù„Ù€ <embed>
      fileEmbed.src = fileUrl;
      fileEmbed.type = mimeType;

      // ØªØ¬Ù‡ÙŠØ² Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ†Ø²ÙŠÙ„
      downloadBtn.href = fileUrl;
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙŠ "download" Ù„Ø¬Ø¹Ù„Ù‡ ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
      downloadBtn.setAttribute('download', fileName);

      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
      modal.classList.remove('hidden');
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ Modal
    function closeViewer() {
      const modal = document.getElementById('viewerModal');
      const fileEmbed = document.getElementById('fileEmbed');
      const downloadBtn = document.getElementById('downloadBtn');

      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
      modal.classList.add('hidden');

      // Ø¥ÙØ±Ø§Øº Ø§Ù„Ù€ src Ùˆ Ø§Ù„Ù€ type Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„ØªÙ†Ø¸ÙŠÙ)
      fileEmbed.src = "";
      fileEmbed.type = "";

      // Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      downloadBtn.href = "#";
      downloadBtn.removeAttribute('download');
    }
  </script>
</body>

</html>
